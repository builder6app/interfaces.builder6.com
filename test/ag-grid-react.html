<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Steedos Airtable View (AG Grid UMD)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css" />
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Ê∑±Â∫¶ÂÆöÂà∂ AG Grid Ê†∑Âºè‰ª•Êé•Ëøë Airtable */
        .ag-theme-alpine {
            --ag-header-height: 40px;
            --ag-row-height: 40px;
            --ag-borders: solid 1px #e2e8f0;
            --ag-row-border-color: #e2e8f0;
            --ag-header-background-color: #f8fafc;
            --ag-odd-row-background-color: #ffffff;
            --ag-font-size: 13px;
            --ag-font-family: 'Inter', system-ui, sans-serif;
        }
        
        .ag-header-cell-label {
            font-weight: 600;
            color: #64748b;
        }

        /* ÈÄâ‰∏≠ÂçïÂÖÉÊ†ºÁöÑËæπÊ°ÜÈ¢úËâ≤ */
        .ag-theme-alpine .ag-ltr .ag-cell-focus:not(.ag-cell-range-selected) {
            border-color: #3b82f6; 
            border-width: 2px !important;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden flex flex-col">

    <div id="root" class="h-full flex flex-col"></div>

    <script>
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // 1. Êï∞ÊçÆÊ®°Êãü (Steedos Metadata & Data)
        // ==========================================
        
        // Ê®°ÊãüÁî®Êà∑Ë°® (Áî®‰∫é Lookup Â≠óÊÆµ)
        const USERS_MAP = {
            "u001": { name: "ÁéãÂª∫ÂõΩ", avatar: "https://i.pravatar.cc/150?u=1" },
            "u002": { name: "ÈôàÊÄùÊÄù", avatar: "https://i.pravatar.cc/150?u=2" },
            "u003": { name: "Âº†‰ºü", avatar: "https://i.pravatar.cc/150?u=3" }
        };

        const steedosFields = [
            { name: "name", label: "‰ªªÂä°ÂêçÁß∞", type: "text", width: 220, pinned: 'left' },
            { name: "status", label: "Áä∂ÊÄÅ", type: "select", options: [
                { label: "ÂæÖÂ§ÑÁêÜ", value: "todo", color: "bg-gray-200 text-gray-700" },
                { label: "ËøõË°å‰∏≠", value: "doing", color: "bg-blue-100 text-blue-700" },
                { label: "Â∑≤ÂÆåÊàê", value: "done", color: "bg-green-100 text-green-700" },
                { label: "ÈòªÂ°û", value: "blocked", color: "bg-red-100 text-red-700" }
            ]},
            { name: "owner", label: "Ë¥üË¥£‰∫∫", type: "lookup", reference_to: "users" },
            { name: "priority", label: "‰ºòÂÖàÁ∫ß", type: "number", icon: "üì∂" }, // ÊºîÁ§∫Êï∞Â≠ó
            { name: "due_date", label: "Êà™Ê≠¢Êó∂Èó¥", type: "date" },
            { name: "is_public", label: "ÂÖ¨ÂºÄ", type: "boolean" },
            { name: "budget", label: "È¢ÑÁÆó", type: "currency" }
        ];

        const initialData = [
            { id: 1, name: "ÂçéÁÇéÈ≠îÊñπË°®ÂçïËÆæËÆ°Âô®ÂºÄÂèë", status: "doing", owner: "u001", priority: 1, due_date: "2024-05-20", is_public: true, budget: 50000 },
            { id: 2, name: "ÈõÜÊàê AG Grid", status: "todo", owner: "u002", priority: 2, due_date: "2024-05-22", is_public: false, budget: 12000 },
            { id: 3, name: "‰øÆÂ§ç Tailwind Ê†∑ÂºèÂÜ≤Á™Å", status: "blocked", owner: "u001", priority: 3, due_date: "2024-05-15", is_public: true, budget: 0 },
            { id: 4, name: "ÂèëÂ∏É v3.0 ÁâàÊú¨", status: "done", owner: "u003", priority: 1, due_date: "2024-04-01", is_public: true, budget: 100000 },
        ];

        // ==========================================
        // 2. Ëá™ÂÆö‰πâ Renderers (Ê∏≤ÊüìÂô®)
        // ==========================================

        // Áä∂ÊÄÅÊ†áÁ≠æÊ∏≤ÊüìÂô®
        function statusCellRenderer(params) {
            if (!params.value) return '';
            // ÊâæÂà∞ÂØπÂ∫îÁöÑ option ÈÖçÁΩÆ
            const field = steedosFields.find(f => f.name === params.colDef.field);
            const option = field?.options?.find(o => o.value === params.value);
            
            if (option) {
                return `<span class="px-2 py-0.5 rounded text-xs font-semibold ${option.color}">${option.label}</span>`;
            }
            return params.value;
        }

        // Lookup (‰∫∫Âëò) Ê∏≤ÊüìÂô®
        function userCellRenderer(params) {
            const userId = params.value;
            const user = USERS_MAP[userId];
            if (!user) return '';
            return `
                <div class="flex items-center h-full">
                    <img src="${user.avatar}" class="w-5 h-5 rounded-full mr-2 border border-gray-300">
                    <span>${user.name}</span>
                </div>
            `;
        }

        // ==========================================
        // 3. React ÁªÑ‰ª∂
        // ==========================================
        function App() {
            const gridDiv = useRef(null); // Grid ÂÆπÂô®
            const gridApi = useRef(null); // Grid API ÂÆû‰æã

            // Â∞Ü Steedos Â≠óÊÆµÂÆö‰πâ ËΩ¨Êç¢‰∏∫ AG Grid Column Defs
            const columnDefs = useMemo(() => {
                return steedosFields.map(field => {
                    const col = {
                        field: field.name,
                        headerName: field.label,
                        width: field.width || 150,
                        editable: true,
                        filter: true,
                        sortable: true,
                        resizable: true,
                    };

                    // --- Á±ªÂûãÊò†Â∞Ñ ---
                    switch(field.type) {
                        case 'select':
                            col.cellRenderer = statusCellRenderer;
                            col.cellEditor = 'agSelectCellEditor';
                            col.cellEditorParams = {
                                values: field.options.map(o => o.value)
                            };
                            // Âú®ÁºñËæëÁä∂ÊÄÅ‰∏ãÔºåÈúÄË¶ÅÊ†ºÂºèÂåñÊòæÁ§∫ label ËÄå‰∏çÊòØ value (AG Grid È´òÁ∫ßÁî®Ê≥ïÈúÄ refDataÔºåËøôÈáåÁÆÄÂåñÂ§ÑÁêÜ)
                            break;
                        
                        case 'lookup':
                            col.cellRenderer = userCellRenderer;
                            col.cellEditor = 'agSelectCellEditor';
                            // ÁÆÄÂçïÊ®°Êãü‰∏ãÊãâÈÄâÊã© ID
                            col.cellEditorParams = {
                                values: Object.keys(USERS_MAP)
                            };
                            // ÁºñËæëÁªìÊùüÂêéÔºåFormatter Ë¥üË¥£Êää ID ËΩ¨‰∏∫ Name ÊòæÁ§∫Âú®Èùû HTML Ê®°Âºè‰∏ã (Â¶ÇÊûú‰∏çÁî® cellRenderer)
                            break;

                        case 'date':
                            col.filter = 'agDateColumnFilter';
                            // AG Grid ÈªòËÆ§Ê≤°ÊúâÊó•ÊúüÈÄâÊã©Âô®Êéß‰ª∂ÔºåÈÄöÂ∏∏ÈúÄË¶ÅËá™ÂÆö‰πâ DateComponent
                            // ËøôÈáå‰ªÖÂà©Áî®ÊµèËßàÂô®ÂéüÁîü type="date" ÁöÑÁÆÄÂçï hack
                            col.cellEditor = class DateEditor {
                                init(params) {
                                    this.eInput = document.createElement('input');
                                    this.eInput.type = 'date';
                                    this.eInput.value = params.value;
                                    this.eInput.classList.add('w-full', 'h-full', 'px-2');
                                }
                                getGui() { return this.eInput; }
                                getValue() { return this.eInput.value; }
                            };
                            break;

                        case 'boolean':
                            col.cellRenderer = params => {
                                return `<input type="checkbox" ${params.value ? 'checked' : ''} disabled class="rounded text-blue-500" />`;
                            };
                            // ÁÆÄÂçïÁöÑÁÇπÂáªÂàáÊç¢
                            col.onCellClicked = (params) => {
                                params.node.setDataValue(field.name, !params.value);
                            };
                            col.editable = false; // Á¶ÅÁî®ÈªòËÆ§ÁºñËæëÂô®Ôºå‰ΩøÁî®ÁÇπÂáªÂàáÊç¢
                            break;
                            
                        case 'currency':
                            col.valueFormatter = params => '¬•' + formatNumber(params.value);
                            col.type = 'numericColumn'; // Âè≥ÂØπÈΩê
                            break;
                            
                        case 'number':
                            col.type = 'numericColumn';
                            break;
                    }

                    return col;
                });
            }, []);

            function formatNumber(number) {
                return Math.floor(number).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
            }

            // ÂàùÂßãÂåñ Grid
            useEffect(() => {
                if (gridDiv.current) {
                    const gridOptions = {
                        columnDefs: columnDefs,
                        rowData: initialData,
                        rowSelection: 'multiple', // ÂÖÅËÆ∏Ë°åÂ§öÈÄâ
                        
                        // Ê†∏ÂøÉÔºöAirtable È£éÊ†ºÁöÑÁºñËæë‰ΩìÈ™å
                        singleClickEdit: true, // ÂçïÂáªÂç≥ÁºñËæë
                        stopEditingWhenCellsLoseFocus: true, // Â§±ÂéªÁÑ¶ÁÇπËá™Âä®‰øùÂ≠ò
                        
                        // Âä®Áîª‰∏éÊ†∑Âºè
                        animateRows: true,
                        headerHeight: 40,
                        rowHeight: 42,

                        // ÈªòËÆ§ÂàóÈÖçÁΩÆ
                        defaultColDef: {
                            flex: 0, // ‰∏çËá™Âä®ÊíëÊª°ÔºåÂÖÅËÆ∏Ê®™ÂêëÊªöÂä®
                            minWidth: 100,
                            filter: true,
                        },
                        
                        // ‰∫ã‰ª∂ÁõëÂê¨
                        onCellValueChanged: (event) => {
                            console.log('Êï∞ÊçÆÂèòÊõ¥:', event.data);
                            // TODO: Ë∞ÉÁî® Steedos API update
                            // steedos.object(objName).update(id, { [field]: value })
                        }
                    };

                    // ÂàõÂª∫ Grid
                    gridApi.current = agGrid.createGrid(gridDiv.current, gridOptions);
                }

                // Ê∏ÖÁêÜ
                return () => {
                    // gridApi.current?.destroy(); // Êñ∞ÁâàAPI‰∏çÈúÄË¶ÅÊâãÂä® destroy
                };
            }, [columnDefs]);

            const addNewRow = () => {
                const newRow = { id: Date.now(), name: "Êñ∞‰ªªÂä°...", status: "todo", priority: 1 };
                gridApi.current.applyTransaction({ add: [newRow] });
            };

            return React.createElement('div', { className: "h-full flex flex-col" }, [
                // Toolbar
                React.createElement('div', { className: "h-14 bg-white border-b border-gray-200 flex items-center px-4 justify-between" }, 
                    React.createElement('div', { className: "flex items-center space-x-2"}, 
                        React.createElement('div', { className: "bg-blue-500 text-white p-1.5 rounded"}, "‚ò∞"),
                        React.createElement('h1', { className: "font-bold text-gray-700 text-lg"}, "È°πÁõÆËßÜÂõæ (All Tasks)")
                    ),
                    React.createElement('button', { 
                        className: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-medium transition",
                        onClick: addNewRow
                    }, "+ Êñ∞Âª∫ËÆ∞ÂΩï")
                ),
                // Grid Container
                React.createElement('div', { 
                    ref: gridDiv, 
                    className: "flex-1 ag-theme-alpine w-full" 
                })
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>