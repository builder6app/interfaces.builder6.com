<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Builder6 Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        #editor { width: 100%; height: 100%; }
        .active-layout, .active-mode { background-color: #4b5563; color: white; }
        
        /* Mobile Preview Styles */
        .mobile-preview {
            width: 375px !important;
            height: 667px !important;
            margin: auto;
            border: 8px solid #1f2937;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .mobile-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            padding: 20px;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-900 text-white">

    <header class="flex items-center justify-between px-6 py-3 border-b border-gray-700 bg-gray-800">
        <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-sky-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12.001 4.8c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624C13.666 10.618 15.027 12 18.001 12c3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C16.337 6.182 14.976 4.8 12.001 4.8zm-6 7.2c-3.2 0-5.2 1.6-6 4.8 1.2-1.6 2.6-2.2 4.2-1.8.913.228 1.565.89 2.288 1.624 1.177 1.194 2.538 2.576 5.512 2.576 3.2 0 5.2-1.6 6-4.8-1.2 1.6-2.6 2.2-4.2 1.8-.913-.228-1.565-.89-2.288-1.624C10.337 13.382 8.976 12 6.001 12z"/></svg>
            <h1 class="font-bold text-lg tracking-tight">Builder6 Play <span class="text-xs font-normal text-gray-400 ml-1">(Lite)</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <!-- Layout Controls -->
            <div class="flex items-center bg-gray-700 rounded-lg p-1 gap-1">
                <button id="layoutLeftRight" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white active-layout" title="Split Left/Right">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
                </button>
                <button id="layoutTopBottom" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white" title="Split Top/Bottom">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <button id="layoutPreview" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white" title="Preview Only">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                </button>
            </div>

            <!-- Preview Mode Controls -->
            <div class="flex items-center bg-gray-700 rounded-lg p-1 gap-1">
                <button id="modeDesktop" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white active-mode" title="Desktop View">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </button>
                <button id="modeMobile" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white" title="Mobile View">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                </button>
                <button id="openNewTab" class="p-1.5 rounded hover:bg-gray-600 text-gray-400 hover:text-white" title="Open in new tab">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </button>
            </div>

            <button id="shareBtn" class="bg-sky-600 hover:bg-sky-500 text-white px-4 py-1.5 rounded text-sm font-medium transition flex items-center gap-2">
                <span>Share</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
            </button>
        </div>
    </header>

    <main id="mainContainer" class="flex-1 flex overflow-hidden flex-row">
        <div id="editorWrapper" class="w-1/2 border-r border-gray-700 flex flex-col">
            <div id="editor-container" class="flex-1"></div>
        </div>

        <div id="previewWrapper" class="w-1/2 bg-white relative">
            <div class="absolute inset-0 bg-white" id="preview-inner">
                <iframe id="preview" class="w-full h-full border-none"></iframe>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <script>
        // 1. 默认代码模板
        const defaultCode = `<div class="min-h-screen bg-gray-100 flex items-center justify-center">
  <div class="p-8 bg-white shadow-lg rounded-2xl max-w-sm">
    <div class="flex items-center space-x-4">
      <div class="shrink-0">
        <img class="h-12 w-12" src="https://cdn.tailwindcss.com/img/logo.svg" alt="ChitChat Logo">
      </div>
      <div>
        <div class="text-xl font-medium text-black">ChitChat</div>
        <p class="text-slate-500">You have a new message!</p>
      </div>
    </div>
  </div>
</div>`;

        let editor;

        // 2. 初始化 Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], async function() {
            // 解析 URL 中的代码（如果有）
            let initialCode = defaultCode;
            const codeFromUrl = await getCodeFromUrl();
            if (codeFromUrl) {
                initialCode = codeFromUrl;
            }

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: initialCode,
                language: 'html',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                padding: { top: 20 }
            });

            // 监听内容变化，更新预览
            editor.onDidChangeModelContent(() => {
                updatePreview();
                updateUrl();
            });

            // 初始化预览
            updatePreview();
        });

        // 3. 更新预览 Iframe
        function updatePreview() {
            const code = editor.getValue();
            const previewFrame = document.getElementById('preview');
            const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            
            // 构建完整的 HTML 页面，注入 Tailwind CDN
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <script src="https://cdn.tailwindcss.com"><\/script>
                </head>
                <body>
                    ${code}
                </body>
                </html>
            `;
            
            doc.open();
            doc.write(htmlContent);
            doc.close();
        }

        // 4. URL 状态管理 (编码与解码)
        // 使用 LZString 压缩，避免 URL 过长
        function updateUrl() {
            const code = editor.getValue();
            const compressed = LZString.compressToEncodedURIComponent(code);
            window.history.replaceState(null, '', '#' + compressed);
        }

        async function getCodeFromUrl() {
            // 优先检查路径 ID (例如 /64f...)
            const path = window.location.pathname;
            if (path && path.length > 1) {
                const id = path.substring(1); // 去掉开头的 /
                try {
                    const response = await fetch(`/api/play/snippets/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.code;
                    }
                } catch (e) {
                    console.error('Failed to load snippet', e);
                }
            }

            // 兼容旧的 query param 方式
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (id) {
                try {
                    const response = await fetch(`/api/play/snippets/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        return data.code;
                    }
                } catch (e) {
                    console.error('Failed to load snippet', e);
                }
            }

            const hash = window.location.hash.substring(1);
            if (!hash) return null;
            return LZString.decompressFromEncodedURIComponent(hash);
        }

        // 5. Share 按钮逻辑 (保存并复制链接)
        document.getElementById('shareBtn').addEventListener('click', async () => {
            const btn = document.getElementById('shareBtn');
            const originalText = btn.innerHTML;
            const code = editor.getValue();
            
            try {
                btn.innerHTML = `<span>Saving...</span>`;
                
                // 1. 保存到后端
                const response = await fetch('/api/play/snippets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code }),
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Saved:', data);
                    
                    // 2. 更新 URL
                    const newUrl = window.location.origin + '/' + data._id;
                    window.history.pushState(null, '', '/' + data._id);
                    
                    // 3. 复制到剪贴板
                    await navigator.clipboard.writeText(newUrl);
                    
                    btn.innerHTML = `<span class="text-green-200">Copied!</span>`;
                } else {
                    btn.innerHTML = `<span class="text-red-300">Failed</span>`;
                }
            } catch (error) {
                console.error('Error:', error);
                btn.innerHTML = `<span class="text-red-300">Error</span>`;
            }
            
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        });

        // 6. Layout & View Controls
        const mainContainer = document.getElementById('mainContainer');
        const editorWrapper = document.getElementById('editorWrapper');
        const previewWrapper = document.getElementById('previewWrapper');
        const previewInner = document.getElementById('preview-inner');
        const previewFrame = document.getElementById('preview');

        // Layout Switching
        document.getElementById('layoutLeftRight').addEventListener('click', () => setLayout('horizontal'));
        document.getElementById('layoutTopBottom').addEventListener('click', () => setLayout('vertical'));
        document.getElementById('layoutPreview').addEventListener('click', () => setLayout('preview'));

        function setLayout(mode) {
            // Update Buttons
            document.getElementById('layoutLeftRight').classList.toggle('active-layout', mode === 'horizontal');
            document.getElementById('layoutTopBottom').classList.toggle('active-layout', mode === 'vertical');
            document.getElementById('layoutPreview').classList.toggle('active-layout', mode === 'preview');

            // Reset classes
            mainContainer.classList.remove('flex-col', 'flex-row');
            editorWrapper.classList.remove('w-full', 'h-1/2', 'border-b', 'w-1/2', 'h-full', 'border-r', 'hidden');
            previewWrapper.classList.remove('w-full', 'h-1/2', 'w-1/2', 'h-full');

            // Update Container
            if (mode === 'horizontal') {
                mainContainer.classList.add('flex-row');
                editorWrapper.classList.add('w-1/2', 'h-full', 'border-r');
                previewWrapper.classList.add('w-1/2', 'h-full');
            } else if (mode === 'vertical') {
                mainContainer.classList.add('flex-col');
                editorWrapper.classList.add('w-full', 'h-1/2', 'border-b');
                previewWrapper.classList.add('w-full', 'h-1/2');
            } else if (mode === 'preview') {
                mainContainer.classList.add('flex-row'); // Default flex direction
                editorWrapper.classList.add('hidden');
                previewWrapper.classList.add('w-full', 'h-full');
            }
            
            // Trigger resize for Monaco Editor
            if (editor) editor.layout();
        }

        // Preview Mode Switching
        document.getElementById('modeDesktop').addEventListener('click', () => setPreviewMode('desktop'));
        document.getElementById('modeMobile').addEventListener('click', () => setPreviewMode('mobile'));
        document.getElementById('openNewTab').addEventListener('click', () => {
            const code = editor.getValue();
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <script src="https://cdn.tailwindcss.com"><\/script>
                </head>
                <body>
                    ${code}
                </body>
                </html>
            `;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        });

        function setPreviewMode(mode) {
            // Update Buttons
            document.getElementById('modeDesktop').classList.toggle('active-mode', mode === 'desktop');
            document.getElementById('modeMobile').classList.toggle('active-mode', mode === 'mobile');

            if (mode === 'mobile') {
                previewWrapper.classList.add('mobile-wrapper');
                previewInner.classList.remove('absolute', 'inset-0');
                previewInner.classList.add('mobile-preview');
                previewFrame.classList.add('rounded-2xl'); // Match border radius
            } else {
                previewWrapper.classList.remove('mobile-wrapper');
                previewInner.classList.add('absolute', 'inset-0');
                previewInner.classList.remove('mobile-preview');
                previewFrame.classList.remove('rounded-2xl');
            }
        }
    </script>
</body>
</html>